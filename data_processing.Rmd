---
title: "Data Processing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
#working directory
rm(list=ls())
setwd("~/Yale/2022 Fall/Tobin RA")
# packages
library(tidyverse)
library(readxl)
library(lattice)
library(Hmisc)
```

# Reading data:
```{r warning=FALSE}
# loading in data
df_2015 <- rbind(read_xlsx("data/2015.xlsx"), read_xlsx("data/2015b.xlsx"))
df_2016 <- read_xlsx("data/2016.xlsx")
df_2017 <- rbind(read_xlsx("data/2017.xlsx"), read_xlsx("data/2017b.xlsx"))
df_2018 <- rbind(read_xlsx("data/2018a.xlsx"),
                 read_xlsx("data/2018b.xlsx"),
                 read_xlsx("data/2018c.xlsx"))
df_2019 <- rbind(read_xlsx("data/2019a.xlsx"),
                 read_xlsx("data/2019b.xlsx"),
                 read_xlsx("data/2019c.xlsx"))
df_2020 <- read_xlsx("data/2020.xlsx")
```

# cleaning gender
```{r}
table(df_2015$GENDER)
```

```{r}
### getting consistent gender labels ###
# coding NAs as "Missing"
df_2015$GENDER[is.na(df_2015$GENDER)] <- "Missing"
df_2016$GENDER[is.na(df_2016$GENDER)] <- "Missing"
df_2017$GENDER[is.na(df_2017$GENDER)] <- "Missing"
df_2018$GENDER[is.na(df_2018$GENDER)] <- "Missing"
df_2019$GENDER[is.na(df_2019$GENDER)] <- "Missing"
df_2020$GENDER[is.na(df_2020$GENDER)] <- "Missing"

# replacing the rest as "Other"
df_2015$GENDER[!(df_2015$GENDER %in% c("Female","Male","Missing"))] <- "Other"
df_2016$GENDER[!(df_2016$GENDER %in% c("Female","Male","Missing"))] <- "Other"
df_2017$GENDER[!(df_2017$GENDER %in% c("Female","Male","Missing"))] <- "Other"
df_2018$GENDER[!(df_2018$GENDER %in% c("Female","Male","Missing"))] <- "Other"
df_2019$GENDER[!(df_2019$GENDER %in% c("Female","Male","Missing"))] <- "Other"
df_2020$GENDER[!(df_2020$GENDER %in% c("Female","Male","Missing"))] <- "Other"


### below doesn't work
# dfList <- list(df_2015, df_2016, df_2017, df_2018, df_2019, df_2020)
# lapply(dfList, function(x){
#   x$GENDER[!(x$GENDER %in% c("Female", "Male", NA))] <- "Other"
# })
# 
# table(df_2015$GENDER)

```

# Cleaning manager_relationship

Note: a scale from Strongly Disagree to Strongly Agree
```{r}
# prepping data for merging
df_2018$MANAGER_RELATIONSHIP <- as.numeric(substr(df_2018$MANAGER_RELATIONSHIP,1,1))
df_2019$MANAGER_RELATIONSHIP <- as.numeric(substr(df_2019$MANAGER_RELATIONSHIP,1,1))
df_2020$MANAGER_RELATIONSHIP <- as.numeric(substr(df_2020$MANAGER_RELATIONSHIP,1,1))
```

# Cleaning fair_pay

Note: a scale from Strongly Disagree to Strongly Agree
```{r}
df_2018$FAIR_PAY <- as.numeric(substr(df_2018$FAIR_PAY,1,1))
df_2019$FAIR_PAY <- as.numeric(substr(df_2019$FAIR_PAY,1,1))
df_2020$FAIR_PAY <- as.numeric(substr(df_2020$FAIR_PAY,1,1))
```


```{r}
nrow(df_2015)
sum(is.na(df_2015$FAIR_PAY))

nrow(df_2016)
sum(is.na(df_2016$FAIR_PAY))

nrow(df_2017)
sum(is.na(df_2017$FAIR_PAY))

nrow(df_2018)
sum(is.na(df_2018$FAIR_PAY))

nrow(df_2019)
sum(is.na(df_2019$FAIR_PAY))

nrow(df_2020)
sum(is.na(df_2020$FAIR_PAY))



summary(df_2016$FAIR_PAY)
barchart(df_2015$FAIR_PAY)
```

Note: almost all data for fair_pay is missing in 2015 & 2016. 

# Cleaning employer_satisfaction

Note: a scale from Strongly Disagree to Strongly Agree
```{r}
df_2018$EMPLOYER_SATISFACTION <- as.numeric(substr(df_2018$EMPLOYER_SATISFACTION,1,1))
df_2019$EMPLOYER_SATISFACTION <- as.numeric(substr(df_2019$EMPLOYER_SATISFACTION,1,1))
df_2020$EMPLOYER_SATISFACTION <- as.numeric(substr(df_2020$EMPLOYER_SATISFACTION,1,1))
```


```{r}
nrow(df_2015)
sum(is.na(df_2015$EMPLOYER_SATISFACTION))

nrow(df_2016)
sum(is.na(df_2016$EMPLOYER_SATISFACTION))

nrow(df_2017)
sum(is.na(df_2017$EMPLOYER_SATISFACTION))

nrow(df_2018)
sum(is.na(df_2018$EMPLOYER_SATISFACTION))

nrow(df_2019)
sum(is.na(df_2019$EMPLOYER_SATISFACTION))

nrow(df_2020)
sum(is.na(df_2020$EMPLOYER_SATISFACTION))
```

# Cleaning transparent_pay
```{r}
# pre-transformation barcharts to make sure I didn't mess up
barchart(df_2018$TRANSPARENT_PAY)
barchart(df_2019$TRANSPARENT_PAY)
barchart(df_2020$TRANSPARENT_PAY)
```

```{r}
# applying transformations
df_2018$TRANSPARENT_PAY <- as.numeric(substr(df_2018$TRANSPARENT_PAY,1,1))
df_2019$TRANSPARENT_PAY <- as.numeric(substr(df_2019$TRANSPARENT_PAY,1,1))
df_2020$TRANSPARENT_PAY <- as.numeric(substr(df_2020$TRANSPARENT_PAY,1,1))

# post transformation barcharts
barchart(as.factor(df_2018$TRANSPARENT_PAY))
barchart(as.factor(df_2019$TRANSPARENT_PAY))
barchart(as.factor(df_2020$TRANSPARENT_PAY))
```


# Cleaning phdyr_graduated
```{r}
df_2018$PHDYR_GRADUATED <- as.factor(df_2018$PHDYR_GRADUATED)
df_2019$PHDYR_GRADUATED <- as.factor(df_2019$PHDYR_GRADUATED)
df_2020$PHDYR_GRADUATED <- as.factor(df_2020$PHDYR_GRADUATED)
# need to account for did not graduate, look more at data struc
```

# Cleaning mbayr_graduated
```{r}
df_2018$MBAYR_GRADUATED <- as.factor(df_2018$MBAYR_GRADUATED)
df_2019$MBAYR_GRADUATED <- as.factor(df_2019$MBAYR_GRADUATED)
df_2020$MBAYR_GRADUATED <- as.factor(df_2020$MBAYR_GRADUATED)
```

# Binding all rows
```{r}
alldata <- bind_rows(df_2015, df_2016, df_2017, df_2018, df_2019, df_2020)
str(alldata)
```

# Cleaning yrs_exp

```{r}
# replacing negative values with NA
alldata <- alldata %>% 
  mutate(YRS_EXP = replace(alldata$YRS_EXP, alldata$YRS_EXP < 0, NA))
```

# Checking TCC
```{r}
describe(alldata$TCC)
ggplot(data=alldata) +
  geom_density(aes(x=TCC), fill = 'steelblue', alpha = 0.7) +
  xlim(c(0,401622))
```

```{r}
# checking if high-paying jobs concentrate in certain roles
alldata %>%
  filter(TCC > quantile(alldata$TCC, 0.99, na.rm = TRUE)) %>%
  {table(.$ONET_BROAD)} %>% sort(decreasing=TRUE) # filtered by 99th data percentile

alldata %>%
  filter(TCC > 401622) %>%
  {table(.$ONET_BROAD)} %>% sort(decreasing=TRUE) # filtered by 2020 99th percentile

```

The majority of outliers are chief executives, physicians, lawyers, operations 
managers, sales managers, financial analysts, and management analysts. Since
they're mostly uniformly in the same career area (upper management), we can just
use the 2020 99th percentile as a cutoff for our data.

```{r}
alldata <- alldata %>% filter(TCC < 401622)
```


# Filtering by age
```{r}
# keeping ages 24 to 54, exlcuding first-time hires and workforce vets
alldata <- alldata %>% filter(AGE>=24 & AGE <= 54)
```


# Saving data into a .RData and .csv
```{r}
save(alldata, file = "alldata.Rdata") #filesize ~ 0.12 GB
# write.csv(alldata, "alldata.csv") filesize ~ 1.2 GB, yikes!
```


```{r}
######### unnecessary code chunk, leaving for reference
# saving data for easy loading next time
# use load() to load data
# save(
#   df_2015,
#   df_2016,
#   df_2017,
#   df_2018,
#   df_2019,
#   df_2020,
#   file="allyears.RData"
# )
```
 
 